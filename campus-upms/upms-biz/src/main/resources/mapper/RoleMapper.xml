<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.admin.biz.mapper.RoleMapper">

	<resultMap id="RoleVOMap" type="com.example.admin.api.vo.RoleVO">
		<id property="id" column="id"/>
		<result property="roleName" column="role_name"/>
		<result property="roleCode" column="role_code"/>
		<result property="sortOrder" column="sort_order"/>
		<result property="status" column="status"/>
		<result property="createdAt" column="create_at"/>
		<result property="updatedAt" column="update_at"/>
		<collection property="menuIds" ofType="java.lang.Long" column="id" select="selectMenuIdsByRoleId"/>
		<collection property="menus" ofType="com.example.admin.api.vo.SysMenuVO" column="id" select="selectMenusByRoleId"/>
	</resultMap>

	<resultMap id="SysMenuVOMap" type="com.example.admin.api.vo.SysMenuVO">
		<id property="id" column="menu_id"/>
		<result property="parentId" column="parent_id"/>
		<result property="menuType" column="menu_type"/>
		<result property="menuIcon" column="menu_icon"/>
		<result property="menuName" column="menu_name"/>
		<result property="sortOrder" column="menu_sort_order"/>
		<result property="isFrame" column="is_frame"/>
		<result property="perms" column="perms"/>
		<result property="path" column="path"/>
		<result property="status" column="menu_status"/>
		<result property="createdAt" column="menu_create_at"/>
	</resultMap>

	<select id="selectMenuIdsByRoleId" resultType="java.lang.Long">
		SELECT menu_id
		FROM role_menu
		WHERE role_id = #{roleId}
	</select>

	<select id="selectMenusByRoleId" resultMap="SysMenuVOMap">
		SELECT
			m.id AS menu_id,
			m.parent_id,
			m.menu_type,
			m.menu_icon,
			m.menu_name,
			m.sort_order AS menu_sort_order,
			m.is_frame,
			m.permission AS perms,
			m.path,
			m.status AS menu_status,
			m.create_at AS menu_create_at
		FROM sys_menu m
		INNER JOIN role_menu rm ON m.id = rm.menu_id
		WHERE rm.role_id = #{roleId}
		ORDER BY m.sort_order
	</select>

	<select id="selectRolePageWithMenus" resultMap="RoleVOMap">
		SELECT
			r.id,
			r.role_name,
			r.role_code,
			r.sort_order,
			r.status,
			r.create_at,
			r.update_at
		FROM role r
		<where>
			<if test="query.roleName != null and query.roleName != ''">
				AND r.role_name LIKE CONCAT('%', #{query.roleName}, '%')
			</if>
			<if test="query.roleCode != null and query.roleCode != ''">
				AND r.role_code LIKE CONCAT('%', #{query.roleCode}, '%')
			</if>
			<if test="query.status != null">
				AND r.status = #{query.status}
			</if>
		</where>
		ORDER BY r.sort_order
	</select>

</mapper>
