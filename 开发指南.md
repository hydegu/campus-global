# 校园微服务系统开发指南

**版本：v4.0（Docker Compose版）**

## 目录
- [项目概述](#项目概述)
- [技术栈](#技术栈)
- [项目结构](#项目结构)
- [开发环境搭建](#开发环境搭建)
- [代码规范](#代码规范)
- [模块说明](#模块说明)
- [开发流程](#开发流程)
- [测试和文档](#测试和文档)
- [端口列表](#端口列表)

---

## 项目概述

本项目是基于Spring Cloud的校园微服务系统骨架，采用前后端分离架构，提供完整的认证授权、服务网关、用户权限管理等基础功能，为业务模块开发提供标准化模板。

### 核心特性
- 基于Spring Cloud Alibaba微服务架构
- OAuth2统一认证授权
- Nacos服务注册与配置中心
- Sentinel服务熔断限流
- Seata分布式事务
- MyBatis Plus持久层框架
- 统一异常处理和响应格式
- 接口文档自动生成

---

## 技术栈

### 后端技术
| 技术 | 版本 | 说明 |
|------|------|------|
| Java | 17 | 开发语言 |
| Spring Boot | 3.5.9 | 基础框架 |
| Spring Cloud | 2025.0.1 | 微服务框架 |
| Spring Cloud Alibaba | 2025.0.0.0 | 阿里云微服务组件 |
| Nacos | 3.1.0 | 服务注册与配置中心 |
| Sentinel | 1.8.4 | 服务熔断限流 |
| Seata | 1.7.0 | 分布式事务 |
| MyBatis Plus | 3.5.15 | ORM框架 |
| MySQL | 9.2.0 | 关系型数据库 |
| Redis | - | 缓存数据库 |
| Hutool | 5.8.42 | 工具类库 |
| SpringDoc OpenAPI | 2.8.14 | API文档 |
| Knife4j | 4.5.0 | API文档增强 |

---

## 项目结构

```
campus/
├── campus-auth/              # 认证授权中心 (端口: 3000)
├── campus-gateway/          # 服务网关 (端口: 9999)
├── campus-upms/             # 用户权限管理模块
│   ├── upms-api/           # API接口定义
│   └── upms-biz/          # 用户权限api模块（待开发）
├── common/                  # 公共模块
│   ├── common-bom/          # 依赖版本管理
│   ├── common-core/         # 核心工具类
│   ├── common-feign/        # Feign调用组件
│   ├── common-mybatis/      # MyBatis封装
│   ├── common-oss/         # 文件存储
│   ├── common-seata/        # 分布式事务
│   ├── common-security/     # 安全组件
│   └── common-swagger/     # 接口文档
├── db/                     # 数据库脚本
├── pom.xml                 # 父POM
└── .gitignore              # Git忽略配置
```

---

## 开发环境搭建

### 1. 前置要求
- JDK 17+
- Maven 3.6+
- Docker

#### 2.1 启动所有环境服务
```bash
docker compose up
```

#### 3 访问各服务控制台

| 服务 | 地址                          | 账号 | 密码 |
|------|-----------------------------|------|------|
| Nacos | http://localhost:8848/nacos | nacos | nacos |
| Sentinel | http://localhost:8858  | sentinel | sentinel |
| Seata | http://localhost:7091  | seata | seata |


### 5. 微服务组件使用

#### Sentinel使用
添加依赖后，使用`@SentinelResource`注解实现限流和熔断：
```java
@GetMapping("/test")
@SentinelResource(value = "test", blockHandler = "handleBlock")
public String test() {
    return "success";
}
```

#### Seata使用(service层方法)
添加依赖后，使用`@GlobalTransactional`注解实现分布式事务：
```java
@GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
public void createOrder(OrderDTO order) {
    stockService.deductStock(order.getProductId(), order.getCount());
    orderMapper.insert(order);
}
```

---

## 代码规范

#### 链式调用
```java
Result<UserInfo> result = new Result<UserInfo>()
    .setCode(1)
    .setMsg("success")
    .setData(userInfo);
```

### 异常处理

#### 统一响应格式
```java
Result.ok();
Result.ok(data);
Result.ok(data, "操作成功");
Result.failed();
Result.failed("操作失败");
```

#### 异常抛出
```java
throw new CheckedException("业务异常信息");
throw new DeniedAuthException("权限不足");
throw new ValidateCodeException("验证码错误");
```

---

## 模块说明

### campus-auth（认证授权中心）
**端口**：3000
**职责**：提供OAuth2认证授权服务
**核心功能**：用户登录、验证码校验、Token生成与刷新

### campus-gateway（服务网关）
**端口**：9999
**职责**：统一入口，路由转发、负载均衡、限流熔断
**核心功能**：路由转发、负载均衡、限流熔断、统一异常处理、API文档聚合

### campus-upms（用户权限管理）
**职责**：提供用户、角色、权限、菜单等基础功能
**模块划分**：
- **upms-api**：API接口定义
- **upms-biz**：业务逻辑实现（Coding）

### common-core（核心工具类）
**职责**：提供通用工具类、常量、异常等基础功能
**核心功能**：
- 统一响应格式 [Result](file:///c:\Users\22417\Desktop\hy\campus-microservice\campus\common\common-core\src\main\java\com\example\common\core\util\Result.java)
- Redis工具类 [RedisUtils](file:///c:\Users\22417\Desktop\hy\campus-microservice\campus\common\common-core\src\main\java\com\example\common\core\util\RedisUtils.java)
- 通用常量 [CommonConstants](file:///c:\Users\22417\Desktop\hy\campus-microservice\campus\common\common-core\src\main\java\com\example\common\core\constant\CommonConstants.java)

### common-feign（Feign调用组件）
**职责**：封装Feign客户端，提供服务间调用能力
**核心功能**：Feign客户端配置、Sentinel熔断降级、请求拦截器
**关键注解**：`@EnableFeignClients`, `@NoToken`

### common-mybatis（MyBatis封装）
**职责**：封装MyBatis Plus，提供统一的数据库操作能力
**核心功能**：自动填充、JSON类型处理器、分页插件、SQL过滤

### common-security（安全组件）
**职责**：提供安全认证和授权功能
**核心功能**：OAuth2 Token解析、权限校验、请求拦截

### common-oss（文件存储）
**职责**：提供文件上传下载功能（预留模块）

### common-seata（分布式事务）
**职责**：提供分布式事务支持（预留模块）

---

## 开发流程

### 1. 新增业务模块

#### 1.1 创建模块目录和pom.xml
```xml
<project>
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.example</groupId>
        <artifactId>example</artifactId>
        <version>${revision}</version>
    </parent>
    <artifactId>campus-{module-name}</artifactId>
    <packaging>jar</packaging>
</project>
```

#### 1.2 在父pom.xml中注册模块
```xml
<modules>
    <module>campus-{module-name}</module>
</modules>
```

#### 1.4 创建配置文件
```yaml
server:
  port: {port}

spring:
  application:
    name: @artifactId@
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_HOST:127.0.0.1}:${NACOS_PORT:8848}
  config:
    import:
      - nacos:application-@profiles.active@.yml
      - nacos:${spring.application.name}-@profiles.active@.yml
```

#### 1.5 在nacos上写配置文件
 such as : dataId = upms-biz-dev.yml

### 4. 配置网关路由
在Nacos配置中心添加网关路由配置：
```yaml

spring:
  cloud:
    gateway:
      routes:
        - id: {module}-route
          uri: lb://campus-{module}
          predicates:
            - Path=/api/{module}/**
          filters:
            - StripPrefix=2

```

### 5. 测试
使用Postman或Knife4j进行接口测试，访问：http://localhost:9999/doc.html
旧项目文档在根目录的upms-doc.js文件

---

### 6. 端口列表
| 服务 | 端口 | 说明 |
|------|------|------|
| 认证中心 | 3000 | OAuth2认证服务 |
| 网关 | 9999 | API网关 |
| Nacos | 8848 | 服务注册与配置中心 |
| Sentinel Dashboard | 8858 | 服务熔断限流控制台 |
| Seata Server | 8091 | 分布式事务服务 |
| Seata Console | 7091 | Seata管理控制台 |
| MySQL | 33306 | 数据库（Docker映射端口） |
| Redis | 36379 | 缓存（Docker映射端口） |
