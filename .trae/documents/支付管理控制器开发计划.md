# 支付管理控制器开发计划

## 1. 需求分析
根据upms-doc.js文件，支付管理相关接口包括：

### 1.1 提现审核相关接口
- 审核拒绝提现申请：PUT /api/user/withdrawal/{id}/reject
- 审核通过提现申请：PUT /api/user/withdrawal/{id}/approve
- 接收交易状态通知：PUT /api/user/withdrawal/status

### 1.2 平台账户管理相关接口
- 新增平台账户：POST /api/sys/settlement-account
- 查询平台账户详情：GET /api/sys/settlement-account/{id}
- 修改平台账户：PUT /api/sys/settlement-account/{id}
- 删除平台账户：DELETE /api/sys/settlement-account/{id}
- 查询打款历史记录：GET /api/sys/settlement-account/{id}/payment-history
- 增加打款记录：POST /api/sys/settlement-account/{id}/payment-history

## 2. 开发步骤

### 2.1 创建支付管理控制器类
- 创建`PaymentController.java`控制器类
- 添加必要的注解和依赖注入
- 配置接口路由前缀

### 2.2 实现提现审核相关接口
1. **审核拒绝提现申请**
   - 路径：`/api/user/withdrawal/{id}/reject`
   - 方法：PUT
   - 参数：id（路径参数），WithdrawalAuditDTO（请求体）
   - 权限：appUser:withdrawal:reject

2. **审核通过提现申请**
   - 路径：`/api/user/withdrawal/{id}/approve`
   - 方法：PUT
   - 参数：id（路径参数），WithdrawalAuditDTO（请求体）
   - 权限：appUser:withdrawal:approve

3. **接收交易状态通知**
   - 路径：`/api/user/withdrawal/status`
   - 方法：PUT
   - 参数：TransactionStatusNotificationDTO（请求体）
   - 权限：appUser:withdrawal:updateStatus

### 2.3 实现平台账户管理相关接口
1. **新增平台账户**
   - 路径：`/api/sys/settlement-account`
   - 方法：POST
   - 参数：SettlementAccountAddDTO（请求体）
   - 权限：system:settlement:add

2. **查询平台账户详情**
   - 路径：`/api/sys/settlement-account/{id}`
   - 方法：GET
   - 参数：id（路径参数）
   - 权限：system:settlement:query

3. **修改平台账户**
   - 路径：`/api/sys/settlement-account/{id}`
   - 方法：PUT
   - 参数：id（路径参数），SettlementAccountUpdateDTO（请求体）
   - 权限：system:settlement:edit

4. **删除平台账户**
   - 路径：`/api/sys/settlement-account/{id}`
   - 方法：DELETE
   - 参数：id（路径参数）
   - 权限：system:settlement:delete

5. **查询打款历史记录**
   - 路径：`/api/sys/settlement-account/{id}/payment-history`
   - 方法：GET
   - 参数：id（路径参数），PaymentHistoryQueryDTO（查询参数）
   - 权限：system:settlement:paymentHistory

6. **增加打款记录**
   - 路径：`/api/sys/settlement-account/{id}/payment-history`
   - 方法：POST
   - 参数：id（路径参数），PaymentHistoryAddDTO（请求体）
   - 权限：system:settlement:paymentHistory:add

### 2.4 定义DTO/VO类
1. **WithdrawalAuditDTO**
   - auditOpinion：审核意见（String，必填）

2. **TransactionStatusNotificationDTO**
   - withdrawalId：提现记录ID（Long，必填）
   - transactionNo：交易流水号（String，必填）
   - status：交易状态（String，必填，枚举值：ok/fail/cancel）
   - failReason：失败原因（String，可选）
   - batchId：微信转账批次单号（String，可选）
   - detailId：微信转账明细单号（String，可选）

3. **TransactionStatusUpdateResponse**
   - withdrawalId：提现记录ID（Long）
   - withdrawalNo：提现单号（String）
   - transactionNo：交易流水号（String）
   - payStatus：更新后的打款状态（Integer，枚举值：0-未打款，1-已打款，2-打款失败）
   - status：更新状态（String）
   - failReason：失败原因（String）
   - updateTime：更新时间（LocalDateTime）

4. **SettlementAccountAddDTO**
   - accountName：账户名称（String，必填）
   - contactPhone：联系方式（String，必填）
   - bankAccountNumber：打款银行卡号（String，必填）
   - bankAccountName：开户名（String，必填）

5. **SettlementAccountUpdateDTO**
   - accountName：账户名称（String，可选）
   - contactPhone：联系方式（String，可选）
   - bankAccountNumber：打款银行卡号（String，可选）
   - paymentTime：支付日期（String，可选）
   - bankAccountName：开户名（String，可选）

6. **PaymentHistoryQueryDTO**
   - keyword：关键字（String，可选）
   - paymentAccount：打款账户（String，可选）
   - paymentDateStart：支付日期开始（String，可选）
   - paymentDateEnd：支付日期结束（String，可选）

7. **PaymentHistoryAddDTO**
   - paymentAccount：收款账户（String，必填）
   - userType：用户类型（Integer，必填）
   - paymentAmount：打款金额（BigDecimal，必填）
   - paymentDate：支付日期（String，必填）

### 2.5 实现业务逻辑
- 提现审核的状态流转
- 交易状态更新的处理
- 平台账户的增删改查
- 打款历史记录的管理
- 事务管理
- 日志记录

## 3. 技术要求
- 使用Spring Boot框架
- 采用RESTful API设计风格
- 实现权限控制
- 数据验证
- 异常处理
- 日志记录

## 4. 预期输出
- 完整的支付管理控制器代码
- 相关DTO/VO类
- 接口文档（自动生成）

## 5. 测试计划
- 单元测试
- 集成测试
- 接口测试

## 6. 注意事项
- 确保接口权限配置正确
- 处理并发问题
- 确保数据一致性
- 考虑异常情况处理
- 实现输入验证
- 添加适当的日志记录