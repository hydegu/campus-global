<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.forum.biz.mapper.ForumActivityCommentMapper">

    <resultMap id="BaseResultMap" type="com.example.forum.api.entity.ForumActivityComment">
        <id property="id" column="id" />
        <result property="activityId" column="activity_id" />
        <result property="userId" column="user_id" />
        <result property="commentContent" column="comment_content" />
        <result property="parentId" column="parent_id" />
        <result property="rootId" column="root_id" />
        <result property="level" column="level" />
        <result property="likeCount" column="like_count" />
        <result property="replyCount" column="reply_count" />
        <result property="status" column="status" />
        <result property="deletedBy" column="delete_by" />
        <result property="deleteAt" column="delete_at" />
        <result property="createAt" column="created_at" />
        <result property="updateAt" column="updated_at" />
    </resultMap>

    <select id="selectCommentByActivityId" resultType="com.example.forum.api.vo.ForumActivityCommentQueryVO">
        select
            fac.id,
            fac.activity_id,
            fac.user_id,
            fac.parent_id,
            fac.root_id,
            fac.comment_content,
            fac.level,
            fac.like_count,
            fac.reply_count,
            fac.status,
            fac.create_at,
            fac.delete_at
        from forum_activity_comment fac
        where fac.activity_id = #{activityId}
            and fac.parent_id = 0
            and fac.status = 1
            and fac.delete_at is null
        ORDER BY fac.create_at DESC
    </select>

    <select id="selectCommentByParentId" resultType="com.example.forum.api.vo.ForumActivityCommentQueryVO">
        select
            fac.id,
            fac.activity_id,
            fac.user_id,
            fac.parent_id,
            fac.root_id,
            fac.comment_content,
            fac.level,
            fac.like_count,
            fac.reply_count,
            fac.status,
            fac.create_at,
            fac.delete_at
        from forum_activity_comment fac
        where fac.activity_id = #{activityId} and fac.parent_id in
        <foreach collection="parentIds" item="parentId" open="(" separator="," close=")">
            #{parentId}
        </foreach>
    </select>

    <select id="selectAllDescendantCommentsByParentIds" resultType="com.example.forum.api.vo.ForumActivityCommentQueryVO">
        WITH RECURSIVE comment_recursive AS (
        -- 基础查询：一级评论的直接子级（二级评论）
        select
        fac.id,
        fac.activity_id,
        fac.user_id,
        fac.parent_id,
        fac.root_id,
        fac.comment_content,
        fac.level,
        fac.like_count,
        fac.reply_count,
        fac.status,
        fac.create_at,
        fac.delete_at,
        1 as depth
        from forum_activity_comment fac
        where fac.activity_id = #{activityId}
        and fac.parent_id in
        <foreach collection="parentIds" item="parentId" open="(" separator="," close=")">
            #{parentId}
        </foreach>
        and fac.delete_at is null
        and fac.status = 1
        
        -- 递归查询：所有后代评论（三级、四级...，通过关联自身ID和父ID实现）
        UNION ALL
        select
        c.id,
        c.activity_id,
        c.user_id,
        c.parent_id,
        c.root_id,
        c.comment_content,
        c.level,
        c.like_count,
        c.reply_count,
        c.status,
        c.create_at,
        c.delete_at,
        cr.depth + 1 as depth
        from forum_activity_comment c
        inner join comment_recursive cr on c.parent_id = cr.id
        where cr.depth &lt; 10  -- 限制递归深度，避免性能问题
        and c.delete_at is null
        and c.status = 1
        )
        -- 最终查询所有递归结果
        select * from comment_recursive order by create_at ASC
    </select>

    <select id="selectAllDescendantCommentsByParentIdsNonRecursive" resultType="com.example.forum.api.vo.ForumActivityCommentQueryVO">
        select
            fac.id,
            fac.activity_id,
            fac.user_id,
            fac.parent_id,
            fac.root_id,
            fac.comment_content,
            fac.level,
            fac.like_count,
            fac.reply_count,
            fac.status,
            fac.create_at,
            fac.delete_at
        from forum_activity_comment fac
        where fac.activity_id = #{activityId}
        <if test="parentIds != null and parentIds.size() > 0">
            and fac.root_id in
            <foreach collection="parentIds" item="parentId" open="(" separator="," close=")">
                #{parentId}
            </foreach>
        </if>
        <if test="parentIds == null or parentIds.size() == 0">
            and 1 = 2
        </if>
        and fac.delete_at is null
        and fac.status = 1
        and fac.level &gt; 0  -- 排除根评论本身
        order by fac.create_at ASC
    </select>

    <update id="updateDeleteByActivityId">
        UPDATE forum_activity_comment
        SET
            status = 2,
            deleted_by = #{userId},
            delete_at = NOW()
        WHERE activity_id = #{activityId} AND status = 1
    </update>

    <select id="selectCommentByParentIdsAndLevel" resultType="com.example.forum.api.vo.ForumActivityCommentQueryVO" >
        select
        fpc.id,
        fpc.activity_id,
        fpc.user_id,
        fpc.parent_id,
        fpc.root_id,
        fpc.comment_content,
        fpc.level,
        fpc.like_count,
        fpc.reply_count,
        fpc.status,
        fpc.create_at,
        fpc.delete_at
        from forum_activity_comment fpc
        where fpc.activity_id = #{activityId}
        and fpc.parent_id in
        <foreach collection="parentIds" item="parentId" open="(" separator="," close=")">
            #{parentId}
        </foreach>
        and fpc.level = #{level}
        and fpc.delete_at is null
        and fpc.status = 1
    </select>
</mapper>